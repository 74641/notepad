<!DOCTYPE html>
<!--
TODO: 
-image storage handling (for inserted pics)-?
-viewing mode vs editing mode (viewing mode would make the top bar hidden and make the div NOT content editable)
-add noteCollection global variable to add and remove elements to it
-What if instead of using onClick="loadNote(this)", the element had a static id
sent in to the function, this way the id is freed up to be used somewhere else-?
-Trash bin for keeping deleted notes for a set time
-Implement Categories
-Renaming titles and categories
-Undo button
  https://quilljs.com/docs/modules/history/
  quill.history.undo();
-Set max height of note collection and set overflow to hidden
-->
<html lang="en_us">

<head>
  <!-- Quill: JS library -->
  <!-- API: https://quilljs.com/docs/api/ -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

  <!-- Quill: CSS stylesheet -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <!-- Materialize (https://materializecss.github.io/materialize/getting-started.html) -->
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@materializecss/materialize@1.1.0/dist/css/materialize.min.css">

  <!-- Compiled and minified JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/@materializecss/materialize@1.1.0/dist/js/materialize.min.js"></script>

  <!--When using type="module", it disallows same-origin script files
      https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS/Errors/CORSRequestNotHttp
      (Basically any javascript that needs to use Quill's resources NEEDS to run in script tags in this html doc)-??
      -any local javascript file listed here can ALSO access other JS files listed here
    -->
  <script src="Notepad.js"></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notepad</title>
</head>


<body>

  <div class="container">
    <div class="section">
      <div class="row">
        <div class="col s8">
          <h3 class="col s12 left-align">Notepad</h3>
        </div>
        <div class="col s4">
          <a href="login form.html" id="loginBtn" class="waves-effect waves-light btn">Logout</a>
        </div>
        <hr class="col s12">
      </div>
    </div>
  </div>

  <div class="container">
    <div class="section">
      <div class="row">
        <div class="col s12 m3" style="border:1px solid gray; padding: 10px; border-radius: 5px;">
          <a id="addBtn" class="waves-effect waves-light btn" onclick="addNote()">+</a>
          <a id="deleteBtn" class="waves-effect waves-light btn" onclick="deleteNote()">-</a>

          <!-- Note Directory -->
          <div id="noteCollection" class="collection">
            <a id="564743" href="#!" onclick="loadNote(this)" class="collection-item">1</a>
            <a id="345765" href="#!" onclick="loadNote(this)" class="collection-item">2</a>
            <a id="798532" href="#!" onclick="loadNote(this)" class="collection-item">3</a>
            <a id="234658" href="#!" onclick="loadNote(this)" class="collection-item">4</a>
          </div>
        </div>

        <div class="col s12 m9" id="editor-area">
          <!--Quill Editor goes here (inserted by addNote())-->
        </div>
      </div>
    </div>
  </div>

  <!--
    <footer class="page-footer orange">
      <div class="container">
        <div class="row">
          <div class="col l6 s12">
            <h5>Notepad</h5>
            <p>
              Notepad
            </p>
          </div>
          <div class="col l3 s12">
            <h5>Settings</h5>
            <ul>
              <li><a href="#!">Link 1</a></li>
              <li><a href="#!">Link 2</a></li>
              <li><a href="#!">Link 3</a></li>
              <li><a href="#!">Link 4</a></li>
            </ul>
          </div>
          <div class="col l3 s12">
            <h5>Connect</h5>
            <ul>
              <li><a href="#!">Link 1</a></li>
              <li><a href="#!">Link 2</a></li>
              <li><a href="#!">Link 3</a></li>
              <li><a href="#!">Link 4</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="footer-copyright">
        <div class="container">
          Made by
          <a class="us" href="https://materializecss.github.io/materialize" target="_blank" rel="noopener noreferrer">Materialize</a>
        </div>
      </div>
    </footer>
    -->

  <script>
    // Notes are saved here, ONLY until the next page refresh, however.
    const saveNoteIDDictionary = {};

    let currentActiveNote = null;
    // Delete and Add interface buttons
    let deleteBtn = document.getElementById("deleteBtn");
    let addBtn = document.getElementById("addBtn");


    // these two can technically just be statically set in the html above...
    let editorContainer = "<div id=editor-container></div>";
    document.getElementById('editor-area').innerHTML = editorContainer;

    var quill = new Quill('#editor-container', {
      modules: {
        toolbar: [
          [{ header: [1, 2, false] }],
          ['bold', 'italic', 'underline'],
          ['image', 'code-block']
        ]
      },
      placeholder: 'Compose an epic...',
      theme: 'snow'  // or 'bubble'
    });
    // Title-?
    //let quillTitle = quill.addContainer('ql-editor');

    // Disable quill, hide delete btn initially 
    quill.enable(false);
    deleteBtn.classList.add('hide');


    // Will run whenever content is changed within the editor
    // TODO: batch saves together-?
    //  smarter detection of active note
    quill.on('text-change', function (delta, oldDelta, source) {
      if (source == 'api') {
        console.log("An API call triggered this change.");
      } else if (source == 'user') {
        console.log("A user action triggered this change.");
        let server = saveNoteIDDictionary[currentActiveNote.id];
        saveNoteIDDictionary[currentActiveNote.id] = quill.getContents();
      }
    });
    // Debug settings -preset notes to empty quill editor output
    saveNoteIDDictionary[564743] = quill.getContents();
    saveNoteIDDictionary[345765] = quill.getContents();
    saveNoteIDDictionary[798532] = quill.getContents();
    saveNoteIDDictionary[234658] = quill.getContents();




    function addNote() {
      // https://stackoverflow.com/questions/54835375/how-to-edit-and-save-my-html-file-using-quill
      // returns a json object with contents of the editor

      // Check if the dictionary already has the generated id (mathematically improbable)
      let newNoteID = Math.random();
      while (saveNoteIDDictionary[newNoteID] != null) {
        alert("Get a lottery ticket " + newNoteID);
        newNoteID = Math.random();
      }
      let newNotePresetTitle = "New Note"
      let addToCollection = '<a id=' + newNoteID + ' href="#!" onclick="loadNote(this)" class="collection-item">' + newNotePresetTitle + '</a>';
      document.getElementById('noteCollection').innerHTML += addToCollection;
      quill.setText('');
      // Initialize the note with the generated note id
      // TODO: create new Note object using Note class
      saveNoteIDDictionary[newNoteID] = quill.getContents();

      // Needed to set active class to the new note
      let nextNote = document.getElementById(newNoteID);
      setActiveNote(nextNote);
    }

    // https://www.geeksforgeeks.org/how-to-remove-an-html-element-using-javascript/
    // TODO: implement trash bin
    function deleteNote() {
      let noteCollection = document.getElementById("noteCollection");
      let noteID = currentActiveNote.id;
      let deletion = document.getElementById(noteID);

      saveNoteIDDictionary[noteID] = null;
      //https://www.tutorialspoint.com/Remove-elements-from-a-Dictionary-using-Javascript
      // Remove save data 
      delete saveNoteIDDictionary[noteID];
      currentActiveNote = null;
      noteCollection.removeChild(deletion);
      quill.setText('');
      quill.enable(false);
      deleteBtn.classList.add('hide');
    }




    // Send in the note id to load the note
    // (The id can be queried using the dictionary)
    // combine loadNote and setActiveNote-?
    function loadNote(nextNote) {
      // DEBUG: alert("Destination Note ID: " + nextNote.id);
      let nextNoteID = nextNote.id;
      let loadSaveData = saveNoteIDDictionary[nextNoteID];

      quill.setContents(loadSaveData);
      setActiveNote(nextNote);
    }


    // Clear previous active note, set active note to parameter note ID
    function setActiveNote(nextNote) {
      // https://stackoverflow.com/questions/13980982/add-class-to-html-with-javascript
      // https://www.w3schools.com/howto/howto_js_remove_class.asp
      // https://stackabuse.com/javascript-check-if-variable-is-a-undefined-or-null/



      let nextNoteID = nextNote.id;

      // Set the note that was clicked to active (if there was a previous active note)
      if (currentActiveNote != null) {
        let currentActiveNoteID = currentActiveNote.id;
        // If there is a note currently active and displayed, set it to NOT active
        if (currentActiveNoteID != nextNoteID) {
          document.getElementById(currentActiveNoteID).classList.remove('active', 'active-note');
          // DEBUG: alert("Previous Note ID: " + currentActiveNoteID);

          // Set the note that was clicked to active
          currentActiveNote = nextNote;
          document.getElementById(nextNoteID).classList.add('active', 'active-note');
        } else {
          // Do nothing (the current active note is the same as the destination)
          // (Basically the user just clicked on the already active note)
        }
      } else {
        // Set the note that was clicked to active (if there was no previous active note)
        currentActiveNote = nextNote;
        document.getElementById(nextNoteID).classList.add('active', 'active-note');
      }
      quill.enable(true);
      deleteBtn.classList.remove('hide');
    }
  </script>


</body>

</html>