<!DOCTYPE html>
<!--
TODO: 
-image storage handling (for inserted pics)-?
-viewing mode vs editing mode (viewing mode would make the top bar hidden and make the div NOT content editable)
-add noteCollection global variable to add and remove elements to it
-What if instead of using onClick="loadNote(this)", the element had a static id
sent in to the function, this way the id is freed up to be used somewhere else-?
-Trash bin for keeping deleted notes for a set time
-Implement Categories
-Renaming titles and categories
-Undo button
  https://quilljs.com/docs/modules/history/
  quill.history.undo();
-Set max height of note collection and set overflow to hidden
-make container width on desktop less restrictive
-->
<html lang="en_us">

<head>
  <!-- JQUERY -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>

  <!-- Quill: JS library -->
  <!-- API: https://quilljs.com/docs/api/ -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

  <!-- Quill: CSS stylesheet -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <!-- Materialize (https://materializecss.github.io/materialize/getting-started.html) -->
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@materializecss/materialize@1.1.0/dist/css/materialize.min.css">

  <!-- Compiled and minified JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/@materializecss/materialize@1.1.0/dist/js/materialize.min.js"></script>

  <!-- Material Icons by Google -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!--When using type="module", it disallows same-origin script files
      https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS/Errors/CORSRequestNotHttp
      (Basically any javascript that needs to use Quill's resources NEEDS to run in script tags in this html doc)-??
      -any local javascript file listed here can ALSO access other JS files listed here
    -->
  <script src="Notepad.js"></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notepad</title>
</head>


<body>

  <header>

    <nav>
      <div class="nav-wrapper blue lighten-5">

        <!-- Sidebar for notes when the screen size is phone or tablet sized -->
        <a id="sidebarBtn" href="#" data-target="slide-out" class="pulse sidenav-trigger btn hide-on-large-only">
          <i class="material-icons">menu</i>
        </a>

        <!-- Logo -->
        <a href="#" class="left brand-logo grey-text text-darken-3">Notepad</a>

        <!-- Temp style tag for fix of materializecss class -->
        <style>
          .brand-logo {
            position: relative !important;
          }
        </style>

        <!-- Dropdown Trigger -->
        <a class='dropdown-trigger btn-flat right' href='#' data-target='dropdown1'>
          <i class="material-icons">person</i>
        </a>

        <!-- Dropdown Structure -->
        <ul id='dropdown1' class='dropdown-content'>
          <li><a href="login form.html">Logout</a></li>
        </ul>

      </div>
    </nav>

  </header>

  <div class="container">
    <div class="section">
      <div class="row">

        <div id="sidebar-on-small-med" class="scale-transition scale-out">

          <div class="col s12 l3" style="border:1px solid gray; padding: 10px; border-radius: 5px;">
            <a id="addBtn" class="waves-effect waves-light btn" onclick="addNote()">+</a>
            <a id="deleteBtn" class="waves-effect waves-light btn" onclick="deleteNote()">-</a>
            <div class="input-field">
              <input id="search" type="search" class="validate">
              <label for="search">Search</label>
            </div>
            <!-- Note Directory -->
            <div id="noteCollection" class="collection">
              <a id="564743" href="#!" onclick="loadNote(this)" class="collection-item">Example 1</a>
              <a id="345765" href="#!" onclick="loadNote(this)" class="collection-item">Example 2</a>
              <a id="798532" href="#!" onclick="loadNote(this)" class="collection-item">Example 3</a>
              <a id="234658" href="#!" onclick="loadNote(this)" class="collection-item">Example 4</a>
            </div>
          </div>

        </div>



        <div class="col s12 l9" id="note-contents">
          <div class="input-field">
            <input id="title" type="search">
            <label for="title">Title</label>
          </div>
          <div id="editor-area">
            <div id=editor-container>
              <!--Quill Editor goes here (inserted by addNote function)-->
            </div>
          </div>
        </div>
      </div>
      <!--end of row-->
    </div>
    <!--end of section-->
  </div>
  <!--end of container-->

  <!--
    <footer class="page-footer orange">
      <div class="footer-copyright">
        <div class="container">
          Made by
          <a class="us" href="https://materializecss.github.io/materialize" target="_blank" rel="noopener noreferrer">Materialize</a>
        </div>
      </div>
    </footer>
  -->

    <!-- Temp Style -->
  <style>
    @media only screen and (min-width: 993px) {
    .container {
      width: 90%;
    }
  }
  </style>
  <script>
    // https://stackoverflow.com/questions/30710114/dynamic-javascript-when-changing-screen-size
    function resize() {
      // https://stackoverflow.com/questions/10180782/jquery-resize-using-browser-maximise-button
      // Set small delay to run the resize op, NEEDED
      //setTimeout(function () {
      if ($(window).width() <= 993) {
        $("#sidebar-on-small-med").attr("id", "slide-out");
        $("#slide-out").removeClass("scale-transition");
        $("#slide-out").addClass("sidenav");
        // Initialize M-CSS Sidenav
        $(document).ready(function () {
          $('.sidenav').sidenav({
            // specify options here
          });
        });
        // If the device is small (phone), set sidenav width to 70% of screen
        // otherwise if it is medium sized, set width to 50%
        if ($(window).width() <= 600) {
          $('#slide-out').css("width", "70%");
        } else {
          $('#slide-out').css("width", "50%");
        }
      }
      else {
        $("#slide-out").attr("id", "sidebar-on-small-med");
        $("#sidebar-on-small-med").removeClass("sidenav")
        $('#sidebar-on-small-med').css("width", "100%");
        // When clicking the sidenav btn, and then switching screen sizes, the transform animation sticks and we need to unset it to have it show again
        $('#sidebar-on-small-med').css("transform", "");
        $("#sidebar-on-small-med").addClass("scale-transition");
        $("#sidebar-on-small-med").addClass("scale-in");
      }
      //}, 100);
    }
    $(window).on("resize", resize);
    resize(); // call once initially

    // Initialize dropdown
    $(document).ready(function () {
      $('.dropdown-trigger').dropdown({
        // specify options here
      });
    });




    // Notes are saved here, ONLY until the next page refresh, however.
    // Query using ajax, the server using the user id to get the contents of the notes
    const saveNoteIDDictionary = {};

    // Initialize currentActiveNote (basically no note is selected on page load)
    let currentActiveNote = null;
    // Delete and Add interface buttons
    let deleteBtn = document.getElementById("deleteBtn");
    let addBtn = document.getElementById("addBtn");

    // Side bar button when screen size is phone or tablet sized
    let sideBar = $('#sidebarBtn');

    // Create quill editor, put it in the editor-container, it will create another element above it in the editor-area div
    var quill = new Quill('#editor-container', {
      modules: {
        toolbar: [
          [{ header: [1, 2, false] }],
          ['bold', 'italic', 'underline'],
          ['image', 'code-block']
        ]
      },
      placeholder: 'Compose an epic...',
      theme: 'snow'  // or 'bubble'
    });
    // Title-?
    let quillTitle = quill.addContainer('ql-editor');

    // Disable quill, hide delete btn initially 
    quill.enable(false);
    deleteBtn.classList.add('hide');


    // Will run whenever content is changed within the editor
    // TODO: batch saves together-?
    //  smarter detection of active note
    quill.on('text-change', function (delta, oldDelta, source) {
      if (source == 'api') {
        console.log("An API call triggered this change.");
      } else if (source == 'user') {
        console.log("A user action triggered this change.");
        let server = saveNoteIDDictionary[currentActiveNote.id];
        saveNoteIDDictionary[currentActiveNote.id] = quill.getContents();
      }
    });
    // Debug settings -preset notes to empty quill editor output
    saveNoteIDDictionary[564743] = quill.getContents();
    saveNoteIDDictionary[345765] = quill.getContents();
    saveNoteIDDictionary[798532] = quill.getContents();
    saveNoteIDDictionary[234658] = quill.getContents();


    // https://www.w3schools.com/jquery/tryit.asp?filename=tryjquery_filters_anything
    $(document).ready(function () {
      $("#search").on("keyup", function () {
        var value = $(this).val().toLowerCase();
        $("#noteCollection *").filter(function () {
          $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
      });
    });





    function addNote() {
      // https://stackoverflow.com/questions/54835375/how-to-edit-and-save-my-html-file-using-quill
      // returns a json object with contents of the editor

      // Check if the dictionary already has the generated id (mathematically improbable)
      let newNoteID = Math.random();
      while (saveNoteIDDictionary[newNoteID] != null) {
        alert("Get a lottery ticket " + newNoteID);
        newNoteID = Math.random();
      }
      let newNotePresetTitle = "New Note"
      let addToCollection = '<a id=' + newNoteID + ' href="#!" onclick="loadNote(this)" class="collection-item">' + newNotePresetTitle + '</a>';
      document.getElementById('noteCollection').innerHTML += addToCollection;
      quill.setText('');
      // Initialize the note with the generated note id
      // TODO: create new Note object using Note class
      saveNoteIDDictionary[newNoteID] = quill.getContents();

      // Needed to set active class to the new note
      let nextNote = document.getElementById(newNoteID);
      setActiveNote(nextNote);
    }

    // https://www.geeksforgeeks.org/how-to-remove-an-html-element-using-javascript/
    // TODO: implement trash bin
    function deleteNote() {
      let noteCollection = document.getElementById("noteCollection");
      let noteID = currentActiveNote.id;
      let deletion = document.getElementById(noteID);

      saveNoteIDDictionary[noteID] = null;
      //https://www.tutorialspoint.com/Remove-elements-from-a-Dictionary-using-Javascript
      // Remove save data 
      delete saveNoteIDDictionary[noteID];
      currentActiveNote = null;
      noteCollection.removeChild(deletion);
      quill.setText('');
      quill.enable(false);
      deleteBtn.classList.add('hide');

      // Enable the pulse effect
      sideBar.addClass("pulse");
    }




    // Send in the note id to load the note
    // (The id can be queried using the dictionary)
    // combine loadNote and setActiveNote-?
    function loadNote(nextNote) {
      // DEBUG: alert("Destination Note ID: " + nextNote.id);
      let nextNoteID = nextNote.id;

      // Get the saved contents of the note from the dictionary
      let loadSaveData = saveNoteIDDictionary[nextNoteID];

      quill.setContents(loadSaveData);
      setActiveNote(nextNote);

      
    }


    // Clear previous active note, set active note to parameter note ID
    function setActiveNote(nextNote) {
      // https://stackoverflow.com/questions/13980982/add-class-to-html-with-javascript
      // https://www.w3schools.com/howto/howto_js_remove_class.asp
      // https://stackabuse.com/javascript-check-if-variable-is-a-undefined-or-null/



      let nextNoteID = nextNote.id;

      // Set the note that was clicked to active (if there was a previous active note)
      if (currentActiveNote != null) {
        let currentActiveNoteID = currentActiveNote.id;
        // If there is a note currently active and displayed, set it to NOT active
        if (currentActiveNoteID != nextNoteID) {
          document.getElementById(currentActiveNoteID).classList.remove('active', 'active-note');
          // DEBUG: alert("Previous Note ID: " + currentActiveNoteID);

          // Set the note that was clicked to active
          currentActiveNote = nextNote;
          document.getElementById(nextNoteID).classList.add('active', 'active-note');
        } else {
          // Do nothing (the current active note is the same as the destination)
          // (Basically the user just clicked on the already active note)
        }
      } else {
        // Set the note that was clicked to active (if there was no previous active note)
        currentActiveNote = nextNote;
        document.getElementById(nextNoteID).classList.add('active', 'active-note');
      }
      quill.enable(true);
      deleteBtn.classList.remove('hide');
      
      // Disable the pulse effect
      sideBar.removeClass("pulse");
    }
  </script>


</body>

</html>